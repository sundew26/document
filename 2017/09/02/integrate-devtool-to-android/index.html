<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>integrate-devtool-to-android | weex使用手册</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="集成 Devtools 到 AndroidUpdated time: 21/07/2017Weex Devtools 能够方便调试 Weex 页面，但此功能离不开 Native 的支持。如何让你的 App 也集成 Devtools，在本章将会详细说明 Android 端如何接入 Weex Devtools。 Android 应用接入添加依赖可以通过 Gradle 或者 Maven 添加对 devt">
<meta name="keywords" content="高阶知识">
<meta property="og:type" content="article">
<meta property="og:title" content="integrate-devtool-to-android">
<meta property="og:url" content="https://github.com/stardew516/2017/09/02/integrate-devtool-to-android/index.html">
<meta property="og:site_name" content="weex使用手册">
<meta property="og:description" content="集成 Devtools 到 AndroidUpdated time: 21/07/2017Weex Devtools 能够方便调试 Weex 页面，但此功能离不开 Native 的支持。如何让你的 App 也集成 Devtools，在本章将会详细说明 Android 端如何接入 Weex Devtools。 Android 应用接入添加依赖可以通过 Gradle 或者 Maven 添加对 devt">
<meta property="og:locale" content="简体中文">
<meta property="og:image" content="http://img.alicdn.com/tps/TB1aKy4NXXXXXacXVXXXXXXXXXX-1019-756.png">
<meta property="og:image" content="http://img.alicdn.com/tps/TB13fwSKFXXXXXDaXXXXXXXXXXX-887-828.png">
<meta property="og:image" content="http://img.alicdn.com/tps/TB1igLoMVXXXXawapXXXXXXXXXX-786-1610.jpg">
<meta property="og:updated_time" content="2017-09-21T03:10:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="integrate-devtool-to-android">
<meta name="twitter:description" content="集成 Devtools 到 AndroidUpdated time: 21/07/2017Weex Devtools 能够方便调试 Weex 页面，但此功能离不开 Native 的支持。如何让你的 App 也集成 Devtools，在本章将会详细说明 Android 端如何接入 Weex Devtools。 Android 应用接入添加依赖可以通过 Gradle 或者 Maven 添加对 devt">
<meta name="twitter:image" content="http://img.alicdn.com/tps/TB1aKy4NXXXXXacXVXXXXXXXXXX-1019-756.png">
  
    <link rel="alternate" href="/atom.xml" title="weex使用手册" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/new.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">weex使用手册</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">这是盗版的--仿写于2017年08~09月--by stardew</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/stardew516"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-integrate-devtool-to-android" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/02/integrate-devtool-to-android/" class="article-date">
  <time datetime="2017-09-01T16:39:21.000Z" itemprop="datePublished">2017-09-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      integrate-devtool-to-android
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="集成-Devtools-到-Android"><a href="#集成-Devtools-到-Android" class="headerlink" title="集成 Devtools 到 Android"></a>集成 Devtools 到 Android</h2><h6 id="Updated-time-21-07-2017"><a href="#Updated-time-21-07-2017" class="headerlink" title="Updated time: 21/07/2017"></a>Updated time: 21/07/2017</h6><p>Weex Devtools 能够方便调试 Weex 页面，但此功能离不开 Native 的支持。如何让你的 App 也集成 Devtools，在本章将会详细说明 Android 端如何接入 Weex Devtools。</p>
<h3 id="Android-应用接入"><a href="#Android-应用接入" class="headerlink" title="Android 应用接入"></a>Android 应用接入</h3><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>可以通过 Gradle 或者 Maven 添加对 devtools aar 的依赖，也可以直接对源码依赖。强烈建议使用最新版本，因为 Weex SDK 和 devtools都在快速的迭代开发中，新版本会有更多惊喜，同时也修复老版本中一些问题。最新的 release 版本可在这里查看。所有的 release 版本都会发布到 <a href="https://bintray.com/alibabaweex/maven/weex_inspector" target="_blank" rel="external">jcenter repo</a>。</p>
<ul>
<li><p>Gradle 依赖</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="section">dependencies</span> &#123;</div><div class="line">  <span class="attribute">compile</span> <span class="string">'com.taobao.android:weex_inspector:<span class="variable">$&#123;version&#125;</span>'</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Maven依赖</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.taobao.android<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weex_inspector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;version&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></div></pre></td></tr></table></figure>
</li>
<li><p>源码依赖</p>
<p>需要复制 <a href="https://github.com/weexteam/weex_devtools_android/tree/master/inspector">inspector</a> 目录到你的 App 的同级目录，然后在工程的<br><code>settings.gradle</code> 文件下添加 <code>include &quot;:inspector&quot;</code>，此过程可以参考 playground 源码的工程配置及其配置，然后在App 的 <code>build.gralde</code> 中添加依赖。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">  <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':inspector'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>另外 weex_inspector 中有一部分包是以 provided 的方式引入，接入方需要自行解决依赖和版本冲突。</p>
<ul>
<li><strong>provided方式引用的包</strong><figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="section">dependencies</span> &#123;</div><div class="line">  <span class="attribute">provided</span> <span class="string">'com.google.code.findbugs:jsr305:2.0.1'</span></div><div class="line">  provided <span class="string">'com.android.support:appcompat-v7:23.1.1'</span></div><div class="line">  provided <span class="string">'com.taobao.android:weex_sdk:0.8.0'</span></div><div class="line">  provided <span class="string">'com.alibaba:fastjson:1.1.45+'</span></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>反射引用的包(0.8.0.0以上版本)</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">  <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp:okhttp:2.3.0'</span></div><div class="line">  <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp:okhttp-ws:2.3.0'</span></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">  <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp:okhttp:3.4.1'</span></div><div class="line">  <span class="keyword">compile</span> <span class="string">'com.squareup.okhttp:okhttp-ws:3.4.1'</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="版本兼容"><a href="#版本兼容" class="headerlink" title="版本兼容"></a>版本兼容</h4><table>
<thead>
<tr>
<th>weex sdk</th>
<th>weex inspector</th>
<th>Debugger Server</th>
</tr>
</thead>
<tbody>
<tr>
<td>0.13+</td>
<td>0.12+</td>
<td>0.2.39+</td>
</tr>
<tr>
<td>0.8.0.1+</td>
<td>0.0.8.1+</td>
<td>0.2.39+</td>
</tr>
<tr>
<td>0.7.0+</td>
<td>0.0.7.13</td>
<td>0.2.38</td>
</tr>
<tr>
<td>0.6.0+</td>
<td>0.0.2.2</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="添加-Debug-模式开关"><a href="#添加-Debug-模式开关" class="headerlink" title="添加 Debug 模式开关"></a>添加 Debug 模式开关</h3><p>控制调试模式的打开和关闭的关键点可以概括为三条规则。</p>
<h5 id="规则一：通过-sRemoteDebugMode-和-sRemoteDebugProxyUrl-来设置开关和-Debugger-Server-地址。"><a href="#规则一：通过-sRemoteDebugMode-和-sRemoteDebugProxyUrl-来设置开关和-Debugger-Server-地址。" class="headerlink" title="规则一：通过 sRemoteDebugMode 和 sRemoteDebugProxyUrl 来设置开关和 Debugger Server 地址。"></a>规则一：通过 <code>sRemoteDebugMode</code> 和 <code>sRemoteDebugProxyUrl</code> 来设置开关和 Debugger Server 地址。</h5><p>Weex SDK 的 <code>WXEnvironment</code> 类里有一对静态变量标记了 Weex 当前的调试模式是否开启分别是：<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> sRemoteDebugMode; <span class="comment">// 是否开启 debug 模式，默认关闭</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">String</span> sRemoteDebugProxyUrl; <span class="comment">// DebugServer的websocket地址</span></div></pre></td></tr></table></figure></p>
<p>无论在 App 中无论以何种方式设置 Debug 模式，都必须在恰当的时机调用类似如下的方法来设置 <code>WXEnvironment.sRemoteDebugMode</code> 和 <code>WXEnvironment.sRemoteDebugProxyUrl</code>。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> initDebugEnvironment(<span class="keyword">boolean</span> enable, <span class="keyword">String</span> host) &#123;</div><div class="line">  WXEnvironment.sRemoteDebugMode = enable;</div><div class="line">  WXEnvironment.sRemoteDebugProxyUrl = <span class="string">"ws://"</span> + host + <span class="string">":8088/debugProxy/native"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="规则二：修改-sRemoteDebugMode-后一定要调用WXSDKEngine-reload-。"><a href="#规则二：修改-sRemoteDebugMode-后一定要调用WXSDKEngine-reload-。" class="headerlink" title="规则二：修改 sRemoteDebugMode 后一定要调用WXSDKEngine.reload()。"></a>规则二：修改 <code>sRemoteDebugMode</code> 后一定要调用<code>WXSDKEngine.reload()</code>。</h5><p>一般來說，在修改了 <code>WXEnvironment.sRemoteDebugMode</code> 以后调用了 <code>WXSDKEngine.reload()</code> 方法才能够使 Debug模式生效。<code>WXSDKEngine.reload()</code> 用来重置 Weex 的运行环境上下文，在切换调试模式时需要调用此方法来创建新的 Weex 运行时和 DebugBridge 并将所有的 JS 调用桥接到调试服务器执行。在 reload 过程中会调用 launchInspector，这就是 SDK 控制 Debug 模式最核心一个方法，其传入参数即为 <code>sRemoteDebugMode</code>，若为 <code>true</code> 则该方法中尝试以反射的方式获取 DebugBridge 用来在远端执行 JS，否则在本地运行。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> launchInspector(<span class="keyword">boolean</span> remoteDebug) &#123;</div><div class="line">  <span class="keyword">if</span> (WXEnvironment.isApkDebugable()) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (mWxDebugProxy != <span class="keyword">null</span>) &#123;</div><div class="line">        mWxDebugProxy.stop();</div><div class="line">      &#125;</div><div class="line">      HackedClass&lt;Object&gt; debugProxyClass = WXHack.<span class="keyword">into</span>(<span class="string">"com.taobao.weex.devtools.debug.DebugServerProxy"</span>);</div><div class="line">      mWxDebugProxy = (IWXDebugProxy) debugProxyClass.constructor(Context.<span class="keyword">class</span>, WXBridgeManager.<span class="keyword">class</span>)</div><div class="line">              .getInstance(WXEnvironment.getApplication(), WXBridgeManager.<span class="keyword">this</span>);</div><div class="line">      <span class="keyword">if</span> (mWxDebugProxy != <span class="keyword">null</span>) &#123;</div><div class="line">        mWxDebugProxy.start();</div><div class="line">        <span class="keyword">if</span> (remoteDebug) &#123;</div><div class="line">          mWXBridge = mWxDebugProxy.getWXBridge();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">if</span> (mWXBridge != <span class="keyword">null</span> &amp;&amp; !(mWXBridge <span class="keyword">instanceof</span> WXBridge)) &#123;</div><div class="line">            mWXBridge = <span class="keyword">null</span>;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (HackAssertionException e) &#123;</div><div class="line">      WXLogUtils.e(<span class="string">"launchInspector HackAssertionException "</span>, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只要遵循上面的原理，开启 Debug 模式的方式和时机可由接入方灵活实现。从 launchInspector 可以看到，SDK 对 devtools 的 aar 包并无强依赖,我们的 App 只需要在 Debug 包中打包该 aar 即可，这样多少可以缓解包大小问题和安全问题。</p>
<p><strong>例外</strong>： <em>若修改 <code>WXEnvironment.sRemoteDebugMode</code> 的时机在 <code>WXBridgeManager</code> 初始化和 restart 和之前则 <code>WXSDKEngine.reload()</code> 可忽略.</em></p>
<h5 id="规则三：通过响应-ACTION-DEBUG-INSTANCE-REFRESH-广播及时刷新。"><a href="#规则三：通过响应-ACTION-DEBUG-INSTANCE-REFRESH-广播及时刷新。" class="headerlink" title="规则三：通过响应 ACTION_DEBUG_INSTANCE_REFRESH 广播及时刷新。"></a>规则三：通过响应 <code>ACTION_DEBUG_INSTANCE_REFRESH</code> 广播及时刷新。</h5><p>广播 <code>ACTION_DEBUG_INSTANCE_REFRESH</code> 在调试模式切换和 Chrome 调试页面刷新时发出，主要用来通知当前的 Weex容器以 Debug 模式重新加载当前页。在 playground 中的处理过程如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">RefreshBroadcastReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  public void onReceive(<span class="type">Context</span> context, <span class="type">Intent</span> intent) &#123;</div><div class="line">    <span class="keyword">if</span> (<span class="type">IWXDebugProxy</span>.<span class="type">ACTION_DEBUG_INSTANCE_REFRESH</span>.equals(intent.getAction())) &#123;</div><div class="line">      <span class="keyword">if</span> (mUri != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="type">TextUtils</span>.equals(mUri.getScheme(), <span class="string">"http"</span>) || <span class="type">TextUtils</span>.equals(mUri.getScheme(), <span class="string">"https"</span>)) &#123;</div><div class="line">          loadWXfromService(mUri.toString());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          loadWXfromLocal(<span class="literal">true</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果接入方的容器未对该广播做处理，那么将不支持刷新和调试过程中编辑代码时的 watch 功能。</p>
<h4 id="接入示例"><a href="#接入示例" class="headerlink" title="接入示例"></a>接入示例</h4><p>最简单方式就是复用 Playground 的相关代码，比如扫码和刷新等模块，但是扫码不是必须的，它只是与 App 通信的一种形式，二维码里的包含 DebugServer IP 及 bundle 地址等信息，用于建立 App 和 Debugger Server 之间的连接及动态加载 bundle。在 Playground 中给出了两种开启 debug 模式的范例。</p>
<ul>
<li>范例1：通过在 <code>XXXApplication</code> 中设置开关打开调试模式<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">  public void onCreate() &#123;</div><div class="line">  <span class="keyword">super</span>.onCreate();</div><div class="line">  initDebugEnvironment(<span class="literal">true</span>, <span class="string">"xxx.xxx.xxx.xxx"</span><span class="comment">/*"DEBUG_SERVER_HOST"*/</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这种方式最直接，在代码中直接 hardcode 了开启调试模式，如果在 SDK 初始化之前调用甚至连 <code>WXSDKEngine.reload()</code> 都不需要调用，接入方如果需要更灵活的策略可以将 <code>initDebugEnvironment(boolean enable, String host)</code> 和 <code>WXSDKEngine.reload()</code> 组合在一起在合适的位置和时机调用即可。</p>
<ul>
<li>范例2：通过扫码打开调试模式<br>Playground 中较多的使用扫码的方式传递信息，不仅用这种方式控制 Debug 模式的开关,而且还通过它来传入 bundle 的 url 直接调试。应当说在开发中这种方式是比较高效的，省去了修改 SDK 代码重复编译和安装 App 的麻烦，缺点就是调试工具这种方式接入需要 App 具有扫码和处理特定规则二维码的能力。除了 Playground 中的方式，接入方亦可根据业务场景对 Debugger 和接入方式进行二次开发。</li>
</ul>
<p>Playground 集成的具体代码可参考如下两个文件：</p>
<ul>
<li><p>开关控制，主要参考对二维码的处理部分，详见 <a href="https://github.com/weexteam/weex_devtools_android/blob/master/playground/app/src/main/java/com/alibaba/weex/WXApplication.java"><code>WXApplication.java</code></a></p>
</li>
<li><p>刷新控制 ，主要参考是对容器 <code>ACTION_DEBUG_INSTANCE_REFRESH</code> 的处理，详见 <a href="https://github.com/weexteam/weex_devtools_android/blob/master/playground/app/src/main/java/com/alibaba/weex/WXPageActivity.java"><code>WXPageActivity.java</code></a></p>
</li>
</ul>
<h3 id="牛刀小试"><a href="#牛刀小试" class="headerlink" title="牛刀小试"></a>牛刀小试</h3><h4 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h4><p>如果未安装 Debugger Server，在命令行执行 <code>npm install -g weex-toolkit</code> 既可以安装调试服务器，运行命令 <code>weex debug</code> 就会启动 DebugServer<br>并打开一个调试页面（详情请查看 <a href="http://weex.apache.org/cn/guide/index.html" target="_blank" rel="external">《Get Started》</a>）。页面下方会展示一个二维码，这个二维码用于向 App 传递 Server 端的地址建立连接。</p>
<img src="http://img.alicdn.com/tps/TB1aKy4NXXXXXacXVXXXXXXXXXX-1019-756.png" class="[box-model]" title="-">
<h4 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h4><p>如果你的 App 客户端完成了以上步骤那么恭喜你已经接入完毕，可以愉快的调试 Weex bundle 了，调试体验和网页调试一致！建议新手首先用官方的 Playground 体验一下调试流程。只需要启动 App 扫描 Chrome 调试页面下方的第一个二维码即可建立与 Debugger Server 的通信，Chorome 的调试页面将会列出连接成功的设备信息。<br><img src="http://img.alicdn.com/tps/TB13fwSKFXXXXXDaXXXXXXXXXXX-887-828.png" class="[box-model]" title="devtools-main"></p>
<h4 id="主要步骤如下"><a href="#主要步骤如下" class="headerlink" title="主要步骤如下"></a>主要步骤如下</h4><ol>
<li>如果你要加载服务器上 bundle，第一步就是要让你的 bundle sever 跑起来. 在 Playground 中特别简单，只需要你到 Weex 源码目录下，运行 <code>./start</code> 即可。</li>
<li>命令行运行 <code>weex debug</code> 启动 Debugger Server，Chrome 将会打开一个网页，在网页下方有一个二维码和简单的介绍。</li>
<li>启动 App 并确认打开调试模式。你将在上一步中打开的网页中看到一个设备列表，每个设备项都有两个按钮，分别是 <code>Debugger</code> 和 <code>Inspector</code>。</li>
<li>点击 Inspector Chrome 将创建 <code>Inspector</code> 网页；点击 <code>Debugger</code> Chrome 将创建 Debugger 网页；二者是相互独立的功能，不相互依赖。</li>
</ol>
<hr>
<h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><h4 id="Devtools-组件介绍"><a href="#Devtools-组件介绍" class="headerlink" title="Devtools 组件介绍"></a>Devtools 组件介绍</h4><p>Devtools 扩展了 <a href="https://developer.chrome.com/devtools/docs/debugger-protocol" target="_blank" rel="external">Chrome Debugging Protocol</a>，在客户端和调试服务器之间的采用 <a href="https://en.wikipedia.org/wiki/JSON-RPC" target="_blank" rel="external">JSON-RPC</a> 作为通信机制，本质上调试过程是两个进程间协同，相互交换控制权及运行结果的过程。更多细节还请阅读<br><a href="http://www.atatech.org/articles/59284" target="_blank" rel="external">Weex Devtools Debugger 的技术选型实录</a>这篇文章。</p>
<ul>
<li><p><strong>客户端</strong></p>
<p>Devtools 客户端作为 aar 被集成 App 中，它通过 webscoket 连接到调试服务器，此处并未做安全检查。出于安全机制及包大小考虑，强烈建议接入方只在 debug 版本中打包此 aar。</p>
</li>
<li><p><strong>服务器</strong></p>
<p>Devtools 服务器端是信息交换的中枢，既连接客户端，又连接 Chrome，大多数情况下扮演一个消息转发服务器和 Runtime Manager 的角色。</p>
</li>
<li><p><strong>Web端</strong></p>
<p>Chrome 的 V8 引擎扮演着 Bundle javascript runtime 的角色。开启 debug 模式后，所有的 bundle js 代码都在该引擎上运行。另一方面我们也复用了 Chrome 前端的调试界面，例如设置断点，查看调用栈等，调试页关闭则 runtime 将会被清理。</p>
</li>
</ul>
<p>调试的大致过程请参考如下时序图。<br><img src="http://img.alicdn.com/tps/TB1igLoMVXXXXawapXXXXXXXXXX-786-1610.jpg" class="[box-model]" title="debug sequence diagram"></p>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><p>在各业务接入过程中，陆续发现一些问题，对高频次的问题解答如下，开发中以 weex debug -V 的方式启动 Debugger Server 可以看到 server 端的 log 信息，对照上文中的时序图对于定位问题还是非常有帮助，建议调试中默认开启 server 端 log。</p>
<ol>
<li><p><strong>扫码 App 在 DebugServerProxy 中抛出 class not found</strong></p>
<p>已知的原因如下：</p>
<ul>
<li>weex_inspector 以 provided 方式引用的包是否引入成功，如 fastjson 等。</li>
<li>weex_inspector 以 compile 方式引用的包是否引入成功，某些 app 重新引入 <code>com.squareup.okhttp:okhttp:2.3.0</code> 和 <code>com.squareup
.okhttp:okhttp-ws:2.3.0</code> 则不再报错。</li>
<li>混淆规则影响反射。</li>
</ul>
</li>
<li><p><strong>playground 扫码调试 crash</strong></p>
<ul>
<li>已知的原因如下：</li>
</ul>
<p>系统为 android 6+，崩溃信息提示进程需要 <code>android.permission.READ_PHONE_STATE</code> 权限，代码中未做权限检查，在 0.0.2.7 版本以后已修复，不再需要此权限。</p>
</li>
<li><p><strong>扫码后设备列表页并没有出现我的设备信息</strong></p>
<p>已知的原因如下：</p>
<ul>
<li>Debugger Server 和手机在不同网段，被防火墙隔离。</li>
<li>手机连接了 PC 端的代理，当前尚不支持。</li>
<li>多进程连接服务器端的同一端口，比如在 Application 的 <code>onCreate</code> 中初始化 sdk，若多个进程连接服务器端的同一端口则报错，在 0.0.2.3 版本以后已支持多进程无此问题。</li>
</ul>
</li>
<li><p><strong>调试过程中频繁刷新连接失败，Server 端提示重新启动 App，非必现</strong></p>
<p>已知的原因如下：</p>
<ul>
<li>多线程操作网络连接引起，在频繁的即断即连时容易触发。在 0.0.7.1 版本已修复。</li>
</ul>
</li>
</ol>
<h3 id="注入自定义WebSocket-Client"><a href="#注入自定义WebSocket-Client" class="headerlink" title="注入自定义WebSocket Client"></a>注入自定义WebSocket Client</h3><p>目前Inspector以反射的方式动态调用了okhttp-ws库中的相关代码，可以兼容的okhttp与okhttp-ws版本为：</p>
<ul>
<li>okhttp, okhttp-ws 2.7.5版本以下</li>
<li>okhttp3, okhttp3-ws 3.5版本以下<br>如果客户端中集成的版本与上述版本不匹配，则可以使用 <code>WeexInspector.overrideWebSocketClient</code> 方法来注入自定义的WebSocket实现，示例：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomWebSocketClient</span> <span class="keyword">implements</span> <span class="title">IWebSocketClient</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> WebSocket ws;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> ws != <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(String wsAddress, <span class="keyword">final</span> WSListener listener)</span> </span>&#123;</div><div class="line">    OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient();</div><div class="line">    okHttpClient.setConnectTimeout(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">    okHttpClient.setReadTimeout(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">    okHttpClient.setWriteTimeout(<span class="number">5</span>, TimeUnit.SECONDS);</div><div class="line">    Request request = <span class="keyword">new</span> Request.Builder().url(wsAddress).build();</div><div class="line">    WebSocketCall webSocketCall = WebSocketCall.create(okHttpClient, request);</div><div class="line">    webSocketCall.enqueue(<span class="keyword">new</span> WebSocketListener() &#123;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(WebSocket webSocket, Request request, Response response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        ws = webSocket;</div><div class="line">        listener.onOpen();</div><div class="line">      &#125;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(BufferedSource payload, WebSocket.PayloadType type)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (WebSocket.PayloadType.TEXT == type) &#123;</div><div class="line">          listener.onMessage(payload.readUtf8());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPong</span><span class="params">(Buffer payload)</span> </span>&#123;</div><div class="line">        <span class="comment">//ignore</span></div><div class="line">      &#125;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(<span class="keyword">int</span> code, String reason)</span> </span>&#123;</div><div class="line">        listener.onClose();</div><div class="line">      &#125;</div><div class="line">      <span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(IOException e)</span> </span>&#123;</div><div class="line">        listener.onFailure(e);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        ws.close(CloseCodes.NORMAL_CLOSURE, <span class="string">"Normal closure"</span>);</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> requestId, String message)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (ws != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        ws.sendMessage(WebSocket.PayloadType.TEXT, <span class="keyword">new</span> Buffer().writeString(message, Charset.defaultCharset()));</div><div class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/stardew516/2017/09/02/integrate-devtool-to-android/" data-id="cj7u32c3o002hhvz6m5z8ik40" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/高阶知识/">高阶知识</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/09/02/integrate-devtool-to-ios/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          integrate-devtool-to-ios
        
      </div>
    </a>
  
  
    <a href="/2017/09/02/extend-jsfm/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">extend-jsfm</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JS-service/">JS service</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Weex-和-Web-平台的差异/">Weex 和 Web 平台的差异</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css-单位/">css 单位</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/native-dom-APIs/">native dom APIs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-标准/">web 标准</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/weex-实例变量/">weex 实例变量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内建模块/">内建模块</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内建组件/">内建组件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/通用事件/">通用事件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/通用特性/">通用特性</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/高阶知识/">高阶知识</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/JS-service/" style="font-size: 10px;">JS service</a> <a href="/tags/Weex-和-Web-平台的差异/" style="font-size: 14px;">Weex 和 Web 平台的差异</a> <a href="/tags/css-单位/" style="font-size: 10px;">css 单位</a> <a href="/tags/native-dom-APIs/" style="font-size: 10px;">native dom APIs</a> <a href="/tags/vue/" style="font-size: 12px;">vue</a> <a href="/tags/web-标准/" style="font-size: 10px;">web 标准</a> <a href="/tags/weex-实例变量/" style="font-size: 10px;">weex 实例变量</a> <a href="/tags/内建模块/" style="font-size: 18px;">内建模块</a> <a href="/tags/内建组件/" style="font-size: 20px;">内建组件</a> <a href="/tags/通用事件/" style="font-size: 10px;">通用事件</a> <a href="/tags/通用特性/" style="font-size: 18px;">通用特性</a> <a href="/tags/高阶知识/" style="font-size: 16px;">高阶知识</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/02/difference-Weex-Vue2-x/">difference-Weex-Vue2-x</a>
          </li>
        
          <li>
            <a href="/2017/09/02/migration-from-weex/">migration-from-weex</a>
          </li>
        
          <li>
            <a href="/2017/09/02/platform-difference/">platform-difference</a>
          </li>
        
          <li>
            <a href="/2017/09/02/migration/">migration</a>
          </li>
        
          <li>
            <a href="/2017/09/02/integrate-devtool-to-ios/">integrate-devtool-to-ios</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 lu.wei<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>